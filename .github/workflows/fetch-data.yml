name: Fetch Data Daily

on:
  schedule:
    - cron: "0 0 * * *" # Runs daily at midnight UTC
  workflow_dispatch: # Allows manual trigger from Actions tab

# üîê Required so the workflow can create branches, commits, PRs, approvals, and merges
permissions:
  contents: write
  pull-requests: write

jobs:
  fetch-and-update:
    runs-on: ubuntu-latest

    # üîê Re-declared at job level for reliability.
    # Some org policies ignore top-level permissions.
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        # Needed so the workflow can modify files and commit changes

      - name: Install pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 10
          run_install: false
        # Installs pnpm without auto-installing deps yet

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "pnpm"
        # Node runtime + dependency cache for faster runs

      - name: Install dependencies
        run: pnpm install

      - name: Fetch Data
        env:
          GOOGLE_SHEETS_CREDENTIALS: ${{ secrets.GOOGLE_SHEETS_CREDENTIALS }}
        run: pnpm data:fetch
        # Your script updates repo data files.
        # If nothing changes ‚Üí no PR will be created later.

      - name: Create Pull Request
        id: cpr
        uses: peter-evans/create-pull-request@v7
        with:
          commit-message: "chore: ü§ñ update data from sheets"
          branch: data-update
          delete-branch: true
          title: "chore: ü§ñ update data from sheets"
          body: |
            ü§ñ Auto-generated PR to update data from Google Sheets.
          labels: automated

        # WHY this action:
        # ‚Ä¢ Detects file changes
        # ‚Ä¢ Commits them
        # ‚Ä¢ Creates or updates a PR
        # ‚Ä¢ Outputs PR number if one exists
        #
        # IMPORTANT:
        # If no files changed ‚Üí no PR ‚Üí later steps must be conditional

      # ‚è≥ GitHub sometimes marks a PR "not mergeable" for a few seconds after creation.
      # Without this delay, auto-approve or auto-merge can fail intermittently.
      - name: Wait for PR to be ready
        if: steps.cpr.outputs.pull-request-number != ''
        run: sleep 10

      # ‚úÖ Auto-approve step
      # Needed if branch protection requires at least one approval
      - name: Auto approve PR
        if: steps.cpr.outputs.pull-request-number != ''
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh pr review \
            --repo ${{ github.repository }} \
            ${{ steps.cpr.outputs.pull-request-number }} \
            --approve

        # WHY:
        # ‚Ä¢ Satisfies "required review" rule
        # ‚Ä¢ Uses GitHub CLI
        # ‚Ä¢ Uses workflow token for auth
        #
        # NOTE:
        # Some org rules do NOT count bot approvals.
        # In that case you must use a PAT secret instead.

      # üîÅ Enable auto-merge instead of immediate merge
      # GitHub will merge when required checks pass
      - name: Enable auto-merge
        if: steps.cpr.outputs.pull-request-number != ''
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh pr merge \
            --repo ${{ github.repository }} \
            ${{ steps.cpr.outputs.pull-request-number }} \
            --auto \
            --squash

        # WHY --auto:
        # ‚Ä¢ Does NOT merge immediately
        # ‚Ä¢ Waits for required status checks
        # ‚Ä¢ Works with protected branches
        #
        # WHY --squash:
        # ‚Ä¢ Keeps history clean for generated commits
